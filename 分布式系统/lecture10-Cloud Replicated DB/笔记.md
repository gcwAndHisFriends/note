# Aurora

如何让可靠数据库作为云基础架构一部分

# EBS

在修改数据页上的真正数据前，先在日志中进行记录:

1:我要去修改x，它原来的值是500，要把它修改成510

2:我要去修改Y......

通过撤销重做日志的方式撤销部分事物带来的修改

# RDS

一个数据库复制到多个可用地区

把data page和日志存储到EBS而不是本地磁盘

镜像服务器将写操作复制到第二组EBS服务器上

必须要等所有副本更新完毕，才算结束

实际发送的是日志条目

此外，可以忽略两个(少量)最慢，或基本死掉的服务器

# Quorum机制

容错目标:即使在读取时，也能进行写操作，或者即使一个地区彻底不可用，也能进行写入。一个地区和另一个服务器挂掉，也能读取。

假设一个服务器die，需要通过剩下replica生成新的replica 快速复制

当数据库服务崩溃，他会创建一个新的实例，允许一个新的数据库服务器

# quorum replica

一般只支持put/get

写入时:要发送给所有服务器，并确保写入被w个replica(w:处理写操作的replica的数量,w<n)所确认

读取时，要发送给所有服务器，从R个replica(处理读操作的replica)读取信息(至少那R个要响应)，

W+R>n

复制写和复制读的至少有一台服务器重叠

quorum可以包含一个没有看到该写请求的服务器 

对于以后收到的读请求，由两类服务器处理，一类没有看到写请求，另一个看到写请求

reader可能会读到不同结果

quorum会用到版本号，每次写就会加上一个版本号，然后使用最大的版本号对应值。(对于每个值都有一个版本号)

这个操作可以隐式忽略速度慢和挂掉的服务器

Aurora的put不会覆写，只是以日志的方式追加

如果前一个事物无法恢复，就不能恢复下一个

系统的操作时惰性的，当要查看时才会将日志的更改提交到page上

在很多时候，数据库服务器不需要发送Quorum读请求，服务器会追踪每个存储服务器实际接收到的日志前缀大小(跟踪日志的条数)读取时会选择存储最新数据的服务器

当一个服务器发现丢失了一个日志时，会通知其他服务器一起丢弃这个日志及其之后的所有日志

存储大数据时

当数据库服务器发一条日志记录时，会查看该日志记录所修改的数据，并弄清楚这份数据时保存在哪个PG(protection groups)中

当一台服务器挂了，数据备份是保存在很多服务器中，可以以并行的方式快速恢复

对于只读型查询(webserver)，可以使用只读的副本服务器