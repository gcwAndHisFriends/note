# frangipani

 一个可伸缩的分布式文件系统

思想:缓存一致性

底层是Petal，是一种分布式存储服务，提供可扩展、高可用性、自动管理的虚拟磁盘。

在上层，多台机器在共享的Petal虚拟磁盘上运行相同的Frangipani文件系统代码，使用分布式锁服务来确保一致性。

Frangipani是在拥有统一管理下的集群中运行的，可以安全的通信。机器之间相互信任。也可以剔除不受信任的机器

显著特征:一组相互协作的机器使用一个公共存储并用锁同步对该存储的访问



课程笔记

缓存一致性:我缓存了一些东西，你修改了，那么我就能知道，我可以看见你所做的修改

分布式事务:对文件系统中的数据结构进行复杂的更新操作

服务器恢复

以上是frangipani的整体设计

每台工作站运行一个frangipani服务器实例，其负责工作站里的文件系统，这个模块上保存了文件系统的数据结构，比如文件内容,inode,目录，文件列表。这些数据是放在一个独立的虚拟磁盘petal上

petal是成对出现的，以方便容错。

当frangipani需要读取写入时，会发送RPC请求给petal服务器，给出具体的bolck来读取。这就导致大部分的文件操作与算力需求都在client

需求:

1:除了home目录不共享，能在共享目录下分享东西。我修改，别人能看见。

2:在任何工作站上都能拿到自己home目录下的所有东西

适用于互相信任的环境。

 将正式文件的副本保存在共享磁盘，我对文件做操作时，其会被缓存在本地(而不是petal)

frangipani不仅在工作站和每个frangipani服务器上缓存，也有write-back caching:一开始，创建文件和写操作只会缓存在本地，过一会才会发到petal,这就导致文件系统的逻辑必须在每个工作站中。petal不需要了解文件系统逻辑，只是单纯进行block的读写

这是一种去中心化的方案

缓存中的修改带来了挑战:

1:(强一致性) 站1(在本地)创建了一个文件/A, (先从petal的/目录下获取当前内容)，然后创建文件就是对副本的修改，并不会马上发回petal。此时站2获取/下的文件列表，站2想看到新建的文件，但看不到

2:(原子性)两个站同时对一个目录修改，一个创建/A，一个创建/B。系统需要支持对同一目录进行并发修改，并得到合理结果(要合并而非覆盖)

3:(单台服务器的可恢复性)工作站在修改完本地缓存后崩溃，希望不要破坏文件系统。即别人来看我的文件，可能不是最新的，但不能是损坏的

解决

1:缓存一致性和线性一致性

缓存一致性协议，通过锁实现，

除了工作站，petal，还有第三种服务器:lock服务器，其有一张表，表上保存锁的名字，对锁命名，为每个文件配一个锁。如果站1使用了文件X，站1就会在X上加上锁(记录最新的使用者)。

每个工作站会追踪它所持有的锁是哪个，即在frangipani工作站中记录了对应文件的锁(以及是哪种锁)，以及缓存的内容

当工作站要读文件时，会先去lock服务器获取对应的锁，接着询问petal获取它所需读的文件目录，然后工作站就会记住自己上面记录了一份文件x的副本，当工作站完成任务后，就释放锁。(仍然持有，但标记为不再使用(idle),当有别人再来申请锁时，才释放)

真正释放锁时，如果对数据进行了修改，就需要先将修改后的数据写回petal

2:原子性

需要具备原子性的多步骤操作，frangipani具有一个由锁驱动的数据库风格的事物系统。通过对于操作过程中的涉及到的所有文件加锁，得到原子性事物。

3:崩溃恢复

一个工作站持有锁，进行一组复杂更新时崩溃。lock服务器已经要求它释放锁，所以它可能已经把**部分**修改写回到了petal,然后在释放前崩溃了。

frangipani使用了预写式日志，当工作站要执行复杂操作，回先发送日志描述它所要做的完整一组操作。当日志落到petal时，才会发送写操作

frangipani每个工作站都有独立的日志，此外工作站的日志放在petal上而不是工作站本地磁盘。

revoke释放锁的步骤

1:将日志写入petal

2:对锁相关的数据块进行写更新的操作

3:发送release消息给petal

此外，frangipani在锁的方面使用了租约，当超过时间就会判定工作站崩溃，lock服务器会告诉活着的工作站，让他们读取崩掉的工作站来重演其最近的操作，以确保他们是完整的。完成后，再回报lock服务器，lock服务器就会释放锁。

如果是在第2步骤开始后崩溃，会同样的重演日志

问题:不能盲目重演日志:可能存储的是过时的日志

petal中的所有数据都有一个版本号，当工作站要修改petal时，会查看现有版本号，创日志时会让版本号+1，已经存入petal的版本号要比保存在日志的版本号高(其他工作站会重演，重演也会做版本号增加)如果petal中版本号大于等于日志版本号，就会忽略。

租约,投票,版本号

预写,日志,读写锁

磁盘,两段,复制器

时间戳

